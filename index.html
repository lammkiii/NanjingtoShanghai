<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å—äº¬ä¸Šæµ· x å‰ä¼Šå¡å“‡ä¹‹æ—…</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-color: #FDFBF6;
            --card-bg: #FFFFFF;
            --text-main: #4A4A4A;
            --text-light: #888888;
            --accent-pink: #FFDBE6;
            --accent-blue: #C8E3F2;
            --accent-yellow: #FFF6C4;
            --nav-active: #FF8BA7;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --line-color: #E0E0E0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-main);
            padding-bottom: 80px;
        }

        /* Header */
        header {
            position: sticky; top: 0;
            background: rgba(253, 251, 246, 0.95); backdrop-filter: blur(10px);
            padding: 15px 20px; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 700; }
        .location-badge {
            background: var(--accent-blue); padding: 5px 12px;
            border-radius: 20px; font-size: 0.8rem; font-weight: bold; cursor: pointer;
        }

        .container { padding: 15px; }

        /* Weather */
        .weather-card {
            background: linear-gradient(135deg, #e0f2ff 0%, #ffffff 100%);
            border-radius: 20px; padding: 15px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow); transition: background 0.5s ease;
        }
        .weather-info h2 { margin: 0; font-size: 1.5rem; }
        .weather-info p { margin: 5px 0 0; font-size: 0.9rem; color: var(--text-light); }
        .weather-icon { font-size: 2rem; color: #7BC4EA; }

        /* Timeline & Cards */
        .timeline { position: relative; padding-left: 20px; }
        .timeline::before {
            content: ''; position: absolute; left: 6px; top: 10px; bottom: 10px;
            width: 2px; background: var(--line-color);
        }
        .timeline-item { position: relative; margin-bottom: 20px; }
        .timeline-dot {
            position: absolute; left: -20px; top: 18px;
            width: 14px; height: 14px; border-radius: 50%;
            background: white; border: 3px solid var(--nav-active); z-index: 1;
        }
        .timeline-dot.fixed-item { border-color: #4A90E2; }

        .card {
            background: var(--card-bg); border-radius: 20px; padding: 18px;
            box-shadow: var(--shadow); position: relative; margin-left: 10px;
            transition: transform 0.1s; cursor: pointer;
        }
        .card:active { transform: scale(0.98); }
        .card.spot { border-left: 5px solid var(--accent-blue); }
        .card.food { border-left: 5px solid var(--accent-pink); }
        .card.transport { border-left: 5px solid var(--accent-yellow); }
        .card.fixed-item { border-left: 5px solid #4A90E2; background: #F0F7FF; }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .time { font-weight: 700; color: var(--nav-active); font-size: 0.9rem; }
        .title { font-size: 1.1rem; font-weight: 700; margin: 5px 0; }
        .desc { font-size: 0.9rem; color: var(--text-light); line-height: 1.5; margin-bottom: 10px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .tag { font-size: 0.75rem; padding: 4px 8px; border-radius: 8px; font-weight: 600; }
        .tag-must-eat { background: #FFE0E0; color: #D64545; }
        .tag-code { background: #FFF3E0; color: #EF6C00; font-family: monospace; }
        .tag-blue { background: #E3F2FD; color: #1976D2; }

        .nav-btn { display: inline-flex; align-items: center; background: #4A90E2; color: white; padding: 8px 16px; border-radius: 50px; font-size: 0.85rem; text-decoration: none; margin-top: 10px; }
        .card-actions { display: flex; gap: 15px; }
        .card-actions i { font-size: 0.9rem; padding: 5px; }

        /* Budget Tabs */
        .budget-tabs { display: flex; justify-content: space-between; background: #eee; padding: 5px; border-radius: 15px; margin-bottom: 15px; }
        .budget-tab { flex: 1; text-align: center; padding: 8px 5px; font-size: 0.85rem; border-radius: 12px; cursor: pointer; color: #888; transition: all 0.3s; }
        .budget-tab.active { background: white; color: var(--nav-active); font-weight: bold; shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .expense-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .expense-price { font-weight: bold; color: #E65100; }
        .total-display { text-align: center; background: var(--accent-yellow); padding: 15px; border-radius: 15px; margin-bottom: 20px; }

        /* Tools & Tab Bar */
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .tool-card { background: var(--card-bg); padding: 20px; border-radius: 20px; text-align: center; box-shadow: var(--shadow); cursor: pointer; }
        .tool-icon { font-size: 1.5rem; margin-bottom: 10px; display: block; }

        .tab-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; background: white; border-radius: 50px; display: flex; justify-content: space-around; padding: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 200; }
        .tab-item { color: var(--text-light); font-size: 1.2rem; padding: 10px; }
        .tab-item.active { color: var(--nav-active); transform: translateY(-2px); }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .modal-card { background: white; width: 85%; max-width: 400px; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto; position: relative; }
        .btn-close { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; color: #999; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold; }
        .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 10px; font-size: 1rem; background: #FAFAFA; }
        .btn-submit { width: 100%; padding: 12px; background: var(--nav-active); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; }

        /* Sections */
        .section { display: none; }
        .section.active { display: block; }
        .day-scroll { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 10px; }
        .day-chip { background: var(--card-bg); padding: 8px 16px; border-radius: 16px; white-space: nowrap; border: 1px solid #eee; transition: all 0.3s; }
        .day-chip.active { background: var(--text-main); color: white; border-color: var(--text-main); }
        .info-detail { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .info-detail:last-child { border: none; }
        .info-title { font-weight: bold; font-size: 1.1rem; color: #4A90E2; margin-bottom: 5px; }
        .info-sub { font-size: 0.9rem; color: var(--text-light); margin-bottom: 3px; }
        .info-content { font-size: 1.1rem; font-weight: bold; margin: 5px 0; }
        .info-address { font-size: 0.9rem; color: #555; background: #f9f9f9; padding: 8px; border-radius: 8px; margin-top: 5px; }
        #detail-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 10px; color: var(--text-main); }
        #detail-time-tag { display: inline-block; background: var(--nav-active); color: white; padding: 4px 10px; border-radius: 10px; font-weight: bold; margin-bottom: 15px; }
        #detail-desc { font-size: 1rem; line-height: 1.8; color: #555; white-space: pre-wrap; }
    </style>
</head>
<body>

    <header>
        <div>
            <h1>ğŸ‡¨ğŸ‡³ è¯æ±å…­æ—¥éŠ</h1>
            <small style="color:var(--text-light)">å³æ™‚é›²ç«¯åŒæ­¥ç‰ˆ</small>
        </div>
        <div class="location-badge" id="current-city" onclick="cycleCity()">å—äº¬</div>
    </header>

    <div class="container">
        <div id="tab-itinerary" class="section active">
            <div class="weather-card">
                <div class="weather-info">
                    <h2 id="weather-temp">--Â°C</h2>
                    <p id="weather-desc">æ›´æ–°ä¸­...</p>
                </div>
                <div class="weather-icon"><i class="fas fa-cloud-sun"></i></div>
            </div>

            <div class="day-scroll" id="day-selector"></div>
            
            <div style="text-align: center; margin: 20px 0; opacity: 0.7; color: var(--text-light); font-size: 0.9rem;">
                 <i class="fas fa-sync-alt fa-spin" style="color:#FFDBE6"></i> è³‡æ–™èˆ‡å¥½å‹å³æ™‚åŒæ­¥ä¸­
            </div>

            <div id="itinerary-list" class="timeline">
                <div style="text-align:center; padding:30px; color:#ccc;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i><br><br>æ­£åœ¨å‘¼å«å‰ä¼Šå¡å“‡æ¬é‹è³‡æ–™...
                </div>
            </div>
        </div>

        <div id="tab-tools" class="section">
            <h2 style="margin-bottom:20px;">ğŸ§° æ—…è¡Œå·¥å…·ç®±</h2>
            <div class="tools-grid">
                <div class="tool-card" onclick="showFlightInfo()">
                    <span class="tool-icon">âœˆï¸</span><strong>èˆªç­è³‡è¨Š</strong>
                </div>
                <div class="tool-card" onclick="showHotelInfo()">
                    <span class="tool-icon">ğŸ¨</span><strong>ä½å®¿è³‡è¨Š</strong>
                </div>
                <div class="tool-card" onclick="showBudgetInfo()">
                    <span class="tool-icon">ğŸ’°</span><strong>è¨˜å¸³/é ç®—</strong>
                </div>
                <div class="tool-card">
                    <span class="tool-icon">ğŸ†˜</span><strong>ç·Šæ€¥è¯çµ¡</strong>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px; border-left: 5px solid #FF8BA7;">
                <h3>ğŸ“ å‚™å¿˜éŒ„</h3>
                <ul style="padding-left: 20px; color: var(--text-main); line-height: 1.8;">
                    <li><strong>èº«ä»½è­‰ã€å›é„‰è­‰ (éå¸¸é‡è¦ï¼)</strong></li>
                    <li>è¿ªå£«å°¼æ—¥å¿…å¸¶ï¼šèº«ä»½è­‰åŸä»¶</li>
                    <li>è½‰æ¥é ­ã€è¡Œå‹•é›»æº</li>
                    <li>å€‹äººå¸¸å‚™è—¥å“</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('itinerary')"><i class="fas fa-map-marked-alt"></i></div>
        <div class="tab-item" onclick="switchTab('tools')"><i class="fas fa-suitcase"></i></div>
        <div class="tab-item" onclick="openAddModal()"><i class="fas fa-plus-circle" style="color:var(--nav-active); font-size:1.4rem;"></i></div> 
    </div>

    <div class="modal-overlay" id="formModal">
        <div class="modal-card">
            <div class="btn-close" onclick="closeModal('formModal')">&times;</div>
            <h3 style="margin-top:0;" id="form-title">âœ¨ æ–°å¢è¡Œç¨‹</h3>
            <input type="hidden" id="input-id">
            <div class="form-group"><label class="form-label">ç¬¬å¹¾å¤©</label><select id="input-day" class="form-select"><option value="1">Day 1</option><option value="2">Day 2</option><option value="3">Day 3</option><option value="4">Day 4</option><option value="5">Day 5</option><option value="6">Day 6</option></select></div>
            <div class="form-group"><label class="form-label">æ™‚é–“</label><input type="time" id="input-time" class="form-input" value="12:00"></div>
            <div class="form-group"><label class="form-label">é¡å‹</label><select id="input-type" class="form-select"><option value="spot">ğŸ“ æ™¯é»</option><option value="food">ğŸœ ç¾é£Ÿ</option><option value="transport">ğŸš— äº¤é€š</option></select></div>
            <div class="form-group"><label class="form-label">æ¨™é¡Œ</label><input type="text" id="input-title" class="form-input" placeholder="ä¾‹å¦‚ï¼šå—äº¬å¤§ç‰Œæª”"></div>
            <div class="form-group"><label class="form-label">æè¿°</label><textarea id="input-desc" class="form-input" rows="3"></textarea></div>
            <div class="form-group"><label class="form-label">åœ°é»</label><input type="text" id="input-location" class="form-input" placeholder="å°èˆªåœ°é»"></div>
            <button class="btn-submit" id="btn-save" onclick="saveData()">ç¢ºèªæ–°å¢</button>
        </div>
    </div>

    <div class="modal-overlay" id="detailModal">
        <div class="modal-card">
            <div class="btn-close" onclick="closeModal('detailModal')">&times;</div>
            <div id="detail-time-tag"></div><div id="detail-title"></div>
            <div style="border-bottom:1px solid #eee; margin-bottom:20px;"></div>
            <div id="detail-desc"></div>
            <a id="detail-nav-btn" href="#" target="_blank" class="btn-submit" style="display:block; text-align:center; text-decoration:none; margin-top:20px;">å°èˆª</a>
        </div>
    </div>

    <div class="modal-overlay" id="flightModal">
        <div class="modal-card">
            <div class="btn-close" onclick="closeModal('flightModal')">&times;</div>
            <h3>âœˆï¸ èˆªç­è³‡è¨Š</h3>
            <div class="info-detail"><div class="info-title">å»ç¨‹ï¼šæ¾³é–€ â” å—äº¬</div><div class="info-sub">12æœˆ18æ—¥</div><div class="info-content">13:00 - 15:25</div><div>MU9798</div></div>
            <div class="info-detail"><div class="info-title">å›ç¨‹ï¼šä¸Šæµ·æµ¦æ± â” æ¾³é–€</div><div class="info-sub">12æœˆ23æ—¥</div><div class="info-content">17:25 - 20:20</div><div>MU9991</div></div>
        </div>
    </div>

    <div class="modal-overlay" id="hotelModal">
        <div class="modal-card">
            <div class="btn-close" onclick="closeModal('hotelModal')">&times;</div>
            <h3>ğŸ¨ ä½å®¿è³‡è¨Š</h3>
            <div class="info-detail"><div class="info-title">å—äº¬ï¼šé‡Œç™½é…’åº—</div><div class="info-sub">12/18 - 12/20</div><div class="info-address">é¼“æ¨“å€ä¸­å¤®è·¯323è™Ÿåˆ©å¥§å¤§å»ˆF4å±¤</div></div>
            <div class="info-detail"><div class="info-title">ä¸Šæµ·ï¼šå»ºåœ‹ç’éš±é…’åº—</div><div class="info-sub">12/20 - 12/23</div><div class="info-address">ä¸Šæµ·æµ¦æ±æ–°å€æ±æ–¹è·¯1277è™Ÿ</div></div>
        </div>
    </div>

    <div class="modal-overlay" id="budgetModal">
        <div class="modal-card">
            <div class="btn-close" onclick="closeModal('budgetModal')">&times;</div>
            <h3 style="margin-top:0;">ğŸ’° è¨˜å¸³æœ¬</h3>
            
            <div class="budget-tabs">
                <div class="budget-tab active" onclick="switchUser('William')">William</div>
                <div class="budget-tab" onclick="switchUser('Stella')">Stella</div>
                <div class="budget-tab" onclick="switchUser('Angie')">Angie</div>
                <div class="budget-tab" onclick="switchUser('January')">January</div>
            </div>

            <div class="total-display">
                <div style="font-size:0.9rem; color:#888;">ç›®å‰ç¸½èŠ±è²»</div>
                <div style="font-size:2rem; font-weight:bold; color:#4A4A4A;" id="user-total">$0</div>
            </div>

            <div style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;" id="expense-list">
                </div>

            <div style="border-top: 1px solid #eee; padding-top: 15px;">
                <h4 style="margin:0 0 10px 0;">æ–°å¢ä¸€ç­†</h4>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="expense-item" class="form-input" placeholder="é …ç›® (å¦‚: å¥¶èŒ¶)" style="flex:2;">
                    <input type="number" id="expense-amount" class="form-input" placeholder="$" style="flex:1;">
                </div>
                <button class="btn-submit" onclick="addExpense()">è¨˜å¸³</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // Firebase Config (travel-app-2025)
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyCTobOEiUOsMyC39HN5WPgN6hD4p4gXxLU",
          authDomain: "travel-app-2025-d66ff.firebaseapp.com",
          projectId: "travel-app-2025-d66ff",
          storageBucket: "travel-app-2025-d66ff.firebasestorage.app",
          messagingSenderId: "4489994526",
          appId: "1:4489994526:web:a65bb6ec562ea364a2a90f"
        };
        // ==========================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const dayLabels = { 1: "Day 1", 2: "Day 2", 3: "Day 3", 4: "Day 4", 5: "Day 5", 6: "Day 6" };
        const cityMap = { 1:"å—äº¬", 2:"å—äº¬", 3:"å—äº¬", 4:"ä¸Šæµ·", 5:"ä¸Šæµ·", 6:"ä¸Šæµ·" };
        const cityCoords = { 'å—äº¬': { lat: 32.0617, lon: 118.7632 }, 'ä¸Šæµ·': { lat: 31.2304, lon: 121.4737 }, 'æ¾³é–€': { lat: 22.1944, lon: 113.5488 } };

        let currentDay = 1;
        let allItineraries = [];
        
        // è¨˜å¸³ç›¸é—œè®Šæ•¸
        let currentUser = 'William';
        let allExpenses = [];

        const fixedItems = [
            { id: "flight_go", day: 1, time: "13:00", type: "fixed-item", title: "âœˆï¸ é£›å¾€å—äº¬ (MU9798)", desc: "æ¾³é–€(MFM) â” å—äº¬(NKG)", location: "æ¾³é–€åœ‹éš›æ©Ÿå ´", isFixed: true, tag: "èˆªç­" },
            { id: "disney_land", day: 5, time: "08:30", type: "fixed-item", title: "ğŸ° ä¸Šæµ·è¿ªå£«å°¼æ¨‚åœ’ (å…¨æ—¥)", desc: "è¨˜å¾—å¸¶èº«ä»½è­‰ï¼\n08:30 - 21:30", location: "ä¸Šæµ·è¿ªå£«å°¼åº¦å‡å€", isFixed: true, tag: "ä¸»é¡Œæ¨‚åœ’" },
            { id: "flight_back", day: 6, time: "17:25", type: "fixed-item", title: "âœˆï¸ é£›å¾€æ¾³é–€ (MU9991)", desc: "ä¸Šæµ·æµ¦æ±(PVG) â” æ¾³é–€(MFM)", location: "ä¸Šæµ·æµ¦æ±åœ‹éš›æ©Ÿå ´T1", isFixed: true, tag: "èˆªç­" }
        ];

        window.onload = function() {
            renderDaySelector();
            listenRealtimeData();
            listenExpenseData(); // ç›£è½è¨˜å¸³è³‡æ–™
            updateWeather("å—äº¬");
        };

        // === è¨˜å¸³åŠŸèƒ½ ===
        function listenExpenseData() {
            db.collection("expenses").orderBy("createdAt", "desc").onSnapshot((snapshot) => {
                allExpenses = [];
                snapshot.forEach((doc) => {
                    allExpenses.push({ id: doc.id, ...doc.data() });
                });
                renderBudget(); // è³‡æ–™æ›´æ–°æ™‚é‡ç¹ªä»‹é¢
            });
        }

        function switchUser(user) {
            currentUser = user;
            document.querySelectorAll('.budget-tab').forEach(el => {
                el.classList.remove('active');
                if(el.textContent === user) el.classList.add('active');
            });
            renderBudget();
        }

        function renderBudget() {
            const list = document.getElementById('expense-list');
            list.innerHTML = '';
            
            // éæ¿¾å‡ºç•¶å‰ä½¿ç”¨è€…çš„èŠ±è²»
            const userExpenses = allExpenses.filter(e => e.user === currentUser);
            
            // è¨ˆç®—ç¸½é¡
            let total = 0;
            userExpenses.forEach(e => {
                total += parseFloat(e.amount);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'expense-item';
                itemDiv.innerHTML = `
                    <span>${e.item}</span>
                    <span class="expense-price">$${e.amount}</span>
                `;
                list.appendChild(itemDiv);
            });
            document.getElementById('user-total').textContent = `$${total}`;
        }

        function addExpense() {
            const item = document.getElementById('expense-item').value;
            const amount = document.getElementById('expense-amount').value;
            if(!item || !amount) return alert("è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡");

            db.collection("expenses").add({
                user: currentUser,
                item: item,
                amount: Number(amount),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('expense-item').value = '';
                document.getElementById('expense-amount').value = '';
            });
        }

        function showBudgetInfo() { openModal('budgetModal'); renderBudget(); }

        // === å…¶ä»–æ ¸å¿ƒåŠŸèƒ½ ===
        function updateWeather(city) {
            const coords = cityCoords[city];
            if (!coords) return;
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current_weather=true&timezone=auto`)
                .then(r => r.json()).then(d => {
                    document.getElementById('weather-temp').textContent = `${Math.round(d.current_weather.temperature)}Â°C`;
                    document.getElementById('weather-desc').textContent = `${city}`;
                });
        }
        function cycleCity() {
            const curr = document.getElementById('current-city').textContent;
            let next = curr === "å—äº¬" ? "ä¸Šæµ·" : (curr === "ä¸Šæµ·" ? "æ¾³é–€" : "å—äº¬");
            document.getElementById('current-city').textContent = next;
            updateWeather(next);
        }
        function listenRealtimeData() {
            db.collection("trips").orderBy("time").onSnapshot((s) => {
                allItineraries = [];
                s.forEach((d) => allItineraries.push({ id: d.id, ...d.data() }));
                renderItinerary(currentDay);
            });
        }
        function saveData() {
            const id = document.getElementById('input-id').value;
            const data = {
                day: parseInt(document.getElementById('input-day').value),
                time: document.getElementById('input-time').value,
                type: document.getElementById('input-type').value,
                title: document.getElementById('input-title').value,
                desc: document.getElementById('input-desc').value,
                location: document.getElementById('input-location').value || document.getElementById('input-title').value
            };
            if(!data.title) return alert("è«‹è¼¸å…¥æ¨™é¡Œ");
            if(id) db.collection("trips").doc(id).update(data).then(() => closeModal('formModal'));
            else {
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                db.collection("trips").add(data).then(() => closeModal('formModal'));
            }
        }
        function renderItinerary(dayId) {
            const list = document.getElementById('itinerary-list');
            list.innerHTML = '';
            let items = [...allItineraries.filter(i => parseInt(i.day) === dayId), ...fixedItems.filter(f => f.day === dayId)];
            items.sort((a, b) => a.time.localeCompare(b.time));
            if(items.length===0) list.innerHTML = `<div style="text-align:center;padding:30px;color:#ccc;">æš«ç„¡è¡Œç¨‹</div>`;
            items.forEach(item => {
                const isFixed = item.isFixed;
                const btns = isFixed ? `<i class="fas fa-lock" style="color:#eee;"></i>` : 
                    `<div class="card-actions"><i class="fas fa-pen" onclick="editItem('${item.id}');event.stopPropagation()"></i><i class="fas fa-trash-alt" onclick="delItem('${item.id}');event.stopPropagation()" style="color:#ffb7b7;"></i></div>`;
                const tagHtml = isFixed ? `<span class="tag tag-blue">${item.tag}</span>` : '';
                list.innerHTML += `
                    <div class="timeline-item">
                        <div class="timeline-dot ${isFixed?'fixed-item':''}"></div>
                        <div class="card ${item.type} ${isFixed?'fixed-item':''}" onclick="showDetail('${encodeURIComponent(JSON.stringify(item))}')">
                            <div class="card-header"><span class="time">${item.time}</span>${btns}</div>
                            <div class="title">${item.title}</div><div class="desc">${item.desc}</div><div class="tags">${tagHtml}</div>
                        </div>
                    </div>`;
            });
        }
        function renderDaySelector() {
            const c = document.getElementById('day-selector'); c.innerHTML='';
            for(let i=1;i<=6;i++){
                const d = document.createElement('div'); d.className=`day-chip ${i===currentDay?'active':''}`;
                d.textContent=`Day ${i}`; d.onclick=()=>{currentDay=i; document.getElementById('current-city').textContent=cityMap[i]; updateWeather(cityMap[i]); renderDaySelector(); renderItinerary(i);}
                c.appendChild(d);
            }
        }
        function showDetail(str) { const i=JSON.parse(decodeURIComponent(str)); document.getElementById('detail-time-tag').textContent=i.time; document.getElementById('detail-title').textContent=i.title; document.getElementById('detail-desc').innerText=i.desc||''; document.getElementById('detail-nav-btn').href=`https://uri.amap.com/navigation?poiname=${encodeURIComponent(i.location)}`; openModal('detailModal'); }
        function editItem(id) { const i=allItineraries.find(x=>x.id===id); if(!i)return; document.getElementById('input-id').value=i.id; document.getElementById('input-day').value=i.day; document.getElementById('input-title').value=i.title; document.getElementById('input-time').value=i.time; document.getElementById('input-desc').value=i.desc; document.getElementById('input-location').value=i.location; openModal('formModal'); }
        function delItem(id) { if(confirm("åˆªé™¤ï¼Ÿ")) db.collection("trips").doc(id).delete(); }
        
        function openModal(id){document.getElementById(id).classList.add('open');}
        function closeModal(id){document.getElementById(id).classList.remove('open');}
        function openAddModal(){document.getElementById('input-id').value='';document.getElementById('input-title').value='';openModal('formModal');}
        function showFlightInfo(){openModal('flightModal');}
        function showHotelInfo(){openModal('hotelModal');}
        function switchTab(t){document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));document.getElementById('tab-'+t).classList.add('active');if(t==='itinerary')document.querySelectorAll('.tab-item')[0].classList.add('active');if(t==='tools')document.querySelectorAll('.tab-item')[1].classList.add('active');}
    </script>
</body>
</html>
